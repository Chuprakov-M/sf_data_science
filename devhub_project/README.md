## <center> Анализ схем севооборота

## Оглавление  
[1. Описание проекта](README.md#1.-Описание-проекта)  
[2. Информация о данных](README.md#Информация-о-данных)  
[3. Обработка исходного набора данных](README.md#3.-Обработка-исходного-набора-данных)  
[4. Моделирование](README.md#4.-Моделирование)  
[4.1. Наивная модель + устойчивые последовательности](README.md#4.1-Наивная-модель-+-устойчивые-последовательности)  
[4.2. Дерево решений](README.md#4.2-Дерево-решений)  
[4.3. Случайный лес](README.md#4.3-Случайный-лес)  
[4.4. Бустинг](README.md#4.4-Бустинг)  
[5. Итоги](README.md#5.-Итоги)

### 1. Описание проекта

Фермеры и агрохолдинги стремятся увеличивать доход, повышая урожайность и снижая издержки. Для этого применяется севооборот — поочерёдное выращивание различных культур: например, сначала сеют озимую рожь, на следующий год — картофель, потом — яровую пшеницу, а после неё — клевер. Это помогает бороться с сорняками и поддерживать плодородность почвы, обогащая её питательными веществами. Чередуя культуры определённом порядке, фермеры экономят на удобрениях и пестицидах.

Зная стратегии севооборота, которые применяют фермеры, можно предсказать, как будут изменяться характеристики почвы и урожайность. Это позволяет прогнозировать объём произведённых продуктов в масштабе регионов и государств, а также изменение цен на международном рынке сельхозпродукции.
    
Задачи проекта:  
* проанализировать набор данных,
* выявить последовательность смены посевных культур на заданных полях за десять лет,
* предсказать, какую культуру там сеяли в 2020 году.
 
Набор данных собран из открытой статистики о посевах во Франции за 2010–2019 год. Предсказание необходимо сделать для 100 полей в регионе Haute-de-France, а также в рандомизированной выборке из 100 000 полей для 2019 года (этой выборки не будет в представленном наборе данных).
Необходимо для каждой точки Point() вывести прогнозируемую культуру посева на указанный год в файле predict.csv.
    
### 2. Информация о данных

Для работы предоставлен справочник растений и их групп, насчитывающий 310 растений и 24 группы.

В данных о посевах 2010-12 годов всего 3 столбца - координаты центра участка, номер участка и группа культур, которая преобладала на участке.

В 2013-2014 годах данных больше. Есть текстовое описание группы культур, но уже с ходу не четко бьется с основным словарем: "ESTIVES LANDES" дается в словаре как "Estives et landes" - мелочь (et), но все же. Также и название меняется с CULT_MAJ на CODE_CULTU.

Более полезны данные о [департаменте](https://ru.wikipedia.org/wiki/Департаменты_Франции), [коммуне](https://ru.wikipedia.org/wiki/Коммуны_Франции), номере участка. Также есть сведения о площади (surf - surface), причем в 3 видах: засеянная, общая и еще какая-то. Вряд ли будет польза от площади, а вот от географии что-то может зависеть. Это и широтно-долготные показатели, и рельеф, и почвы, и климат (включая гидрологический режим) - беря департамент как переменную, считаем климатические показатели относительно однородными по всей его территории.  
Еще есть поле FORME_JURI - что-то, связанное с организационно-правовой формой (ОПФ) владельца участка.

В данных 2013-2014 гг есть проблемы с числовыми полями - CODE_CULTU, а также поля о площади текстовые, хотя д.б. числовые. И конечно же находим там лишнее - 'NR', как и для организационно-правовых форм. Заодно убеждаемся, что code_cultu - это группа растений, а не конкретное растение, несмотря на название (в словаре кодов Code Culture - это именно трехбуквенное сокращение вида растений, а тут - группа).

Также стоит отметить, что размеры таблиц за разные годы хоть и незначительно, но отличаются. Есть и дубли - поля с одинаковыми центрами, причем с 2010 по 2013 на первом месте - классический пропуск данных, выраженный словом "empty".

Данные для train 2015-2019 гг. и test 2015-2018 гг. более однотипные - 3 столбца: культура, группа культуры (в кодах) и центр участка. Центр участка является единым сквозным полем для соединения таблиц. Количество строк одинаковое, что вполне разумно и логично. Поля (их центры) тоже уникальные. Всего train + test = 3 614 804 + 401 645 = 4 016 449. test равен 10% от этого числа. Странно что одного поля до 4 016 450 не хватает. Для test 2015-2020 гг. дано 27 участков, на которых надо предсказать культуру 2020 года.

### 3. Обработка исходного набора данных

Так как надо моделировать 2019 и 2020 год, то создание баз для моделирования и предсказания приобретает свои тонкости.

Для 2019 года мы можем использовать массив данных за 2010-2018 годы, причем для 2010-14 есть только группа культур, а для 2015 по 2018 - конкретная культура. Т.е. для года t (= 2019) в годы [t-1, t-4] есть конкретная культура, а в годы [t-5, t-9] - группа культур.
Такую же структуру нужно получить и для моделирования 2020 года: 2016-2019 - конкретная культура, 2011-2015 - группа культур.

По идее административно-территориальное деление Франции не менялось, так что принадлежность участка департаменту можно считать постоянной. 

При этом оказалось, что данные за 2010-2014 гг. не присоединяются к последующим данным по координатам. В проекте показывается на примерах, что координаты почему-то раньше были другие. Поэтому их напрямую использовать нельзя, хотя ценность переменных хотя бы групп культур в эти годы была бы весома.

Поэтому из данных 2010-2014 гг. можно попытаться извлечь хотя бы информацию о департаменте. Анализ был проведен в отдельном проекте - "2. Департаменты Франции.ipynb" - для удобства, т.к. довольно объемный, с большим количеством графиков и на 80+ мб.

Итог анализа - построение дерева решений, которое размечает поля по департаментам практически без выбросов (в проекте формируется модель и сохраняется в файл tree_department.pkl).

### 4. Моделирование

Моделирование было произведено с последовательным усложнением используемых подходов и моделей. В качестве метрики использован показатель accuracy - доля правильно предсказанных культур.

#### 4.1. Наивная модель + устойчивые последовательности
Так как культура обычно меняется каждый год, а если не меняется, то это что-то стандартное многолетнее (луга, виноградники), то для наивной модели можно взять в качестве прогноза в год t культуру за t-2, t-3 и t-4. 

Наивная модель, говорящая, что на поле будет расти культура такая же, какая росла 2 года назад, уже дает accuracy = 68%. Так как далее разнообразие культур было меньше, то и качество прогноза понижается. Так как на прошлый и позапрошлый относительно моделируемого года годы пришлось наибольшее количество культур, то их в 2019 году мы так предсказать просто не можем, что накладывает ограничение на точность прогноза сверху.

Для улучшения наивного прогноза были взяты последовательности культур (специально созданное поле culture_str), и для каждой достаточно часто встречающейся последовательности выбрана самая частая культура, которая встречается после них. Если она будет встречаться в 70 (80, 90, 95)% случаев, то назовем такую культуру и такую последовательность устойчивыми. Устойчивую культуру можно считать прогнозом, а для остальных последовательностей остается наивная модель.

Топ по частоте последовательностей и следующая за ними чаще всего культура:

|последовательность	|частота|	основная культура|	доля основной культуры|
--------------------|-------|--------------------|------------------------|
|PPH-PPH-PPH-PPH    |1067701|                 PPH|                   0.991|
|VRC-VRC-VRC-VRC    | 181790|                 VRC|                   0.987|
|J6S-J6S-J6S-J6S    |  99680|                 J6S|                   0.962|
|SNE-SNE-SNE-SNE    |  85720|                 SNE|                   0.976|
|PRL-PRL-PRL-PRL    |  79333|                 PRL|                   0.958|
|PTR-PTR-PTR-PTR    |  70907|                 PTR|                   0.771|
|BTA-BTA-BTA-BTA    |  67871|                 BTA|                   0.971|
|SPH-SPH-SPH-SPH    |  56682|                 SPH|                   0.987|
|MIS-MIS-MIS-MIS    |  53627|                 MIS|                   0.849|
|PRL-PTR-PTR-PTR    |  41217|                 PRL|                   0.903|
|PPH-PTR-PTR-PTR    |  34253|                 PPH|                   0.843|

У лидеров по количеству комбинаций (включая топ - с четвертью наблюдений) - высокая неизменность. Также видно, что для по крайней мере ТОП-10 последовательностей каждый год код культуры один и тот же. Относительно низкая неизменность - менее 80% - у PTR - Autre prairie temporaire de 5 ans ou moins (Другие временные пастбища 5 лет или менее - google.translate) - видимо, все же трудно предсказать, когда луг распашут и засеют. 85% - у MIS: Autre culture non précisée dans la liste (Другая культура, не указанная в списке). Предсказать иное/прочее/другое тоже непросто.

Для наивной модели точность получилась почти 69%. Если использовать устойчивые последовательности, то точность поднимется до 73%.

Чем больше мы потребуем минимальную точность для определения устойчивой последовательности, тем ниже качество такой модели. Также оно снижается с ростом минимального количества повторений последовательности. Это логично, т.к. такие условия - ужесточение модели

#### 4.2. Дерево решений
С помощью GridSearch оптимальным признано дерево с глубиной 18 и минимальным размером листа 10. Модель получилась относительно сбалансированной, не сильно переобученной - разница tran и test - около 1.3%.

accuracy на Train: 82.50%
accuracy на тестовом наборе: 81.16%

При добавлении устойчивых последовательностей (используем прогноз по устойчивой последовательности, если последовательность устойчивая, иначе - прогноз по дереву решений) accuracy меньше, чем у дерева, как и ожидалось. Даже для последовательностей растений, когда 4 года был один и тот же вид, дереву удалось предсказать следующую культуру точнее.

#### 4.3. Случайный лес
Для случайного леса в качестве параметров дерева были взяты отпимальные параметры для модели дерева, а количество деревьев изменялось от 25 до 200 с шагом 25.

В итоге случайный лес поднимает accuracy на тесте на 0.5% до 81.7%. При этом достаточно уже 50 деревьев, после чего начинаются мизерные приросты точности:  
accuracy на тесте при n_estimators=150: 81.71%.  
accuracy на тесте при n_estimators=125: 81.70%.  
accuracy на тесте при n_estimators=100: 81.70%.  
accuracy на тесте при n_estimators=75: 81.68%.  
accuracy на тесте при n_estimators=50: 81.67%.  
accuracy на тесте при n_estimators=25: 81.64%.

В качестве итоговой взята модель на 100 деревьях.

Лес помог снизить разницу между train и test: 82.40% - 81.70% = 0.7% (на дереве было 1.3%).

#### 4.4. Бустинг

Для бустинга использвалась библиотека CatBoost.

Так как бустинг - довольно долгая процедура, а последовательности из 4 одинаковых растений PPH-PPH-PPH-PPH предсказыва.ncz довольно неплохо, то их из построения можно исключить.

Были подобраны параметры обучения, которые поднимают качество, и при этом модель считается за приемлемое (10-715 минут) время.

При увеличении параметра depth качество растет, но и время тоже. Также рост будет при увеличении iterations. Но тогда время будет совсем большим. На видеокарте, как отмечено в комментариях кода, расчет будет гораздо быстрее, но каждый раз с новым результатом.

Построим модели по департаметам в отдельном проекте "3. Модели CatBoost.ipynb". В результате для каждого департамента создастся файл boost_dep_<\i>.pkl с моделью и файл calc_dep_<\i>.pkl с рассчитанным предсказанием по модели (i - код департамента).

accuracy бустинга на train: 92.80%.  
accuracy бустинга на test: 82.32%.  

В итоге прирост accuracy на тесте составил 0.6% (с 81.7 до 82.3). На train, само собой, переобучение.
При росте количества итераций до 1000 по умолчанию и при построении дерева на максимальную глубину качество, видимо, поднимется еще.

### 5. Итоги  
Пусть есть база из полей с культурами и типами культур за последние 4 года. Тогда необходимо:

1) Присвоить каждому полю "модельный" департамент с помощью дерева решений tree_department.pkl)
2) Закодировать все текстовые признаки c помощью кодировщика bin_encoder.pkl
3) Разбить координаты поля на x и y и округлить их до 100
4) Создать строку культур за 4 года

И в итоге привести к формату, для которого можно применять модель.

Так как случайный лес и примененный бустинг близки по качеству, сохранены предсказания по обеим моделям:
* predict_2019_boost.csv - прогноз-2019, catboost  
* predict_2019_forest.csv - прогноз-2019, случайный лес  
* predict_2020_boost.csv - прогноз-2020, catboost 
* predict_2020_forest.csv - прогноз-2020, случайный лес

Итоговая таблица результатов
+-----------------------------------+--------------+--------------+
|модель                             |accuracy train| accuracy test|
|-----------------------------------|--------------|--------------|
|наивная                            |                        68,9%|
|с устойчивыми последовательностями |                        72,9%|
|дерево решений                     |         82,5%|         81,2%|
|случайный лес                      |         82,4%|         81,7%|
|catboost                           |         92,8%|         82,3%|

\* для наивной модели и модели с устойчивыми последовательностями деления на train/test не было ввиду элементарности подхода и отсутствия сложных зависимостей.

